#!/bin/bash
# echo $@
REPO_PATH=$PWD
# current package.json version/name
NPM_PACKAGE_VERSION=$1
#NPM_PACKAGE_VERSION=$(npm run env | sed -n 's/^npm_package_version=//p')
#NPM_PACKAGE_NAME=$(npm run env | sed -n 's/^npm_package_name=//p')
# get last published npm version
#NPM_LAST_PACKAGE_VERSION=$(npm view $NPM_PACKAGE_NAME versions --json | sed -n '1h;1!{x;H;};${g;p;}' | tr '\n' ' ' | sed 's/[^0-9]*\([0-9.]*\).*/\1/')
DOC_PATH=$2
PUB_PATH=$3
PUB_BRANCH=$4
PUB_REPO_URL=$5
PUB_USER=$6
PUB_EMAIL=$7
PUB_MESSAGE=$8
# checkout
pushd $HOME
git clone --branch=$PUB_BRANCH $PUB_REPO_URL $PUB_PATH 2>&1 > /dev/null
cd $PUB_PATH
# recursively copy the latest docs to the root gh-pages
cp -r $DOC_PATH/* ./
# recursively copy the current docs to the version directory and root directory
mkdir -p ./$NPM_PACKAGE_VERSION
cp -r $DOC_PATH/* ./$NPM_PACKAGE_VERSION
# publish to github
echo "Publishing to $PUB_BRANCH for: $PUB_MESSAGE"
git add .
git config user.name  $PUB_USER
git config user.email $PUB_EMAIL
git commit -m $PUB_MESSAGE
git push -fq origin $PUB_BRANCH 2>&1 > /dev/null
popd